<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Payment Plan</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:'Prompt',sans-serif;background:linear-gradient(to bottom right,#d2f1f9,#e6fcef);margin:0}
    .top-bar{display:flex;justify-content:flex-end;align-items:center;padding:16px 24px;gap:12px}
    .back-btn{background:#f3f4f6;border:none;padding:6px 12px;font-size:14px;color:#374151;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px}
    select{padding:6px 10px;border-radius:8px;font-size:14px}
    .container{max-width:860px;margin:0 auto 40px;background:#fff;padding:24px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.05)}
    h2{text-align:center;color:#0f9d58;margin:4px 0 18px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:700;margin-bottom:6px}
    .form-group input,.form-group select{padding:10px;font-size:16px;border:1px solid #ccc;border-radius:8px}
    .full{grid-column:1 / -1}
    .btn{background:#10b981;color:#fff;padding:12px 20px;border:none;border-radius:8px;font-size:16px;cursor:pointer;width:100%;margin-top:8px}
    .btn.save{background:#0ea5e9}
    .result{margin-top:20px;text-align:center;color:#0f5132}
    .result .badge{display:inline-block;margin:8px 6px;padding:6px 10px;border-radius:9999px;background:#eefbf5;border:1px solid #b7f0d0;font-size:13px}
    .chart-container{max-width:420px;margin:26px auto}
    canvas{max-height:240px!important}
    .muted{color:#6b7280;font-size:13px}
    .hidden{display:none}
  </style>
</head>
<body>

  <div class="top-bar">
    <button onclick="history.back()" class="back-btn"><span id="back-label">Back</span></button>
    <select id="lang" onchange="changeLang()">
      <option value="en" selected>EN</option>
      <option value="th">TH</option>
    </select>
  </div>

  <div class="container">
    <h2 id="title">Home Payment Plan</h2>

    <form id="home-plan-form" class="grid">
      <!-- Income & expenses -->
      <div class="form-group">
        <label id="income-label" for="income">Monthly Income (THB)</label>
        <input id="income" type="text" value="0" required oninput="formatNumber(this)"/>
      </div>
      <div class="form-group">
        <label id="expense-label" for="expenses">Other Monthly Expenses (THB)</label>
        <input id="expenses" type="text" value="0" required oninput="formatNumber(this)"/>
      </div>
      <div class="form-group">
        <label id="savings-label" for="savings">Savings (THB)</label>
        <input id="savings" type="text" value="0" required oninput="formatNumber(this)"/>
      </div>

      <!-- Price & down payment -->
      <div class="form-group">
        <label id="price-label" for="homePrice">Home Price (THB)</label>
        <input id="homePrice" type="text" value="0" required oninput="formatNumber(this)"/>
      </div>
      <div class="form-group">
        <label id="down-label" for="downPayment">Down Payment (THB)</label>
        <input id="downPayment" type="text" value="0" required oninput="formatNumber(this)"/>
      </div>

      <!-- Interest -->
      <div class="form-group">
        <label id="interest-type-label" for="interestType">Interest Type</label>
        <select id="interestType" onchange="toggleInterestInputs()">
          <option value="yearly" selected>Per Year (%)</option>
          <option value="monthly">Per Month (%)</option>
        </select>
      </div>

      <div id="yearlyBox" class="form-group">
        <label id="interest-label-yearly" for="interestYearly">Interest Rate per Year (%)</label>
        <input id="interestYearly" type="number" step="0.01" value="0"/>
      </div>
      <div id="monthlyBox" class="form-group hidden">
        <label id="interest-label-monthly" for="interestMonthly">Interest Rate per Month (%)</label>
        <input id="interestMonthly" type="number" step="0.01" value="0"/>
      </div>

      <!-- Term & carrying costs -->
      <div class="form-group">
        <label id="term-label" for="years">Loan Term (Years)</label>
        <input id="years" type="number" value="30" required/>
      </div>
      <div class="form-group">
        <label id="tax-label" for="propTax">Property Tax per Year (%)</label>
        <input id="propTax" type="number" step="0.01" value="0.00"/>
      </div>
      <div class="form-group">
        <label id="ins-label" for="insYear">Home Insurance per Year (THB)</label>
        <input id="insYear" type="text" value="0" oninput="formatNumber(this)"/>
      </div>
      <div class="form-group">
        <label id="hoa-label" for="hoa">HOA/Condo Fee per Month (THB)</label>
        <input id="hoa" type="text" value="0" oninput="formatNumber(this)"/>
      </div>

      <div class="form-group full">
        <button id="calc-btn" type="submit" class="btn">Calculate</button>
        <button id="save-btn" type="button" class="btn save">Save Calculation</button>
        <div class="muted" id="hint">Recommendation uses 28/36 rule (PITI ‚â§ 28% of income, PITI+other ‚â§ 36%).</div>
      </div>
    </form>

    <div id="result" class="result"></div>
    <div class="chart-container"><canvas id="homeChart"></canvas></div>
  </div>

  <!-- ===== MMMHistory (Guest-aware v2) ‚Äî ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ===== -->
  <script>
    (function(){
      if (window.MMMHistory && window.MMMHistory.__v === '2') return;
      const KEY = "mmm_history_v1";
      const isUser = ()=> (localStorage.getItem('mmm_session') === 'user');

      function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
      function getAll(){ try{ return JSON.parse(localStorage.getItem(KEY))||[]; }catch(e){ return []; } }
      function setAll(l){ localStorage.setItem(KEY, JSON.stringify(l)); }

      function save(entry){
        if(!isUser()){
          alert((localStorage.getItem('language')==='th')
            ? '‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'
            : 'Guest mode: Please log in to save your history.');
          return null;
        }
        const item={ id:uid(), createdAt:new Date().toISOString(), ...entry };
        const list=getAll(); list.unshift(item); setAll(list); return item.id;
      }
      function remove(id){
        if(!isUser()){
          alert((localStorage.getItem('language')==='th')
            ? '‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'
            : 'Guest mode: Delete is disabled.');
          return;
        }
        setAll(getAll().filter(x=>x.id!==id));
      }
      function clear(){
        if(!isUser()){
          alert((localStorage.getItem('language')==='th')
            ? '‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ'
            : 'Guest mode: Clear all is disabled.');
          return;
        }
        localStorage.removeItem(KEY);
      }
      function get(id){ return getAll().find(x=>x.id===id); }

      window.MMMHistory={__v:'2', save, getAll, get, remove, clear, isUser};
    })();
  </script>

  <script>
    const langData = {
      en:{
        title:"Home Payment Plan",
        incomeLabel:"Monthly Income (THB)",
        expenseLabel:"Other Monthly Expenses (THB)",
        savingsLabel:"Savings (THB)",
        priceLabel:"Home Price (THB)",
        downLabel:"Down Payment (THB)",
        interestType:"Interest Type",
        interestYearly:"Per Year (%)",
        interestMonthly:"Per Month (%)",
        interestLabelYearly:"Interest Rate per Year (%)",
        interestLabelMonthly:"Interest Rate per Month (%)",
        termLabel:"Loan Term (Years)",
        taxLabel:"Property Tax per Year (%)",
        insLabel:"Home Insurance per Year (THB)",
        hoaLabel:"HOA/Condo Fee per Month (THB)",
        calcBtn:"Calculate",
        saveBtn:"Save Calculation",
        savedMsg:"Saved!",
        backLabel:"Back",
        chartTitle:"Loan Breakdown",
        hint:"Recommendation uses 28/36 rule (PITI ‚â§ 28% of income, PITI + other ‚â§ 36%).",
        pass28:"‚úÖ Housing cost ‚â§ 28% of income",
        pass36:"‚úÖ Housing + other ‚â§ 36% of income",
        fail28:"‚ùå Housing cost > 28% of income",
        fail36:"‚ùå Housing + other > 36% of income",
        recYes:"‚úÖ You can afford this mortgage.",
        recNo:"‚ùå Not recommended to take this mortgage.",
        currency:"THB",
        labels:{principal:"Principal",interest:"Interest"}
      },
      th:{
        title:"‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô",
        incomeLabel:"‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)",
        expenseLabel:"‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)",
        savingsLabel:"‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö (‡∏ö‡∏≤‡∏ó)",
        priceLabel:"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)",
        downLabel:"‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (‡∏ö‡∏≤‡∏ó)",
        interestType:"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢",
        interestYearly:"‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%)",
        interestMonthly:"‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)",
        interestLabelYearly:"‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%)",
        interestLabelMonthly:"‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)",
        termLabel:"‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏õ‡∏µ)",
        taxLabel:"‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô/‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%)",
        insLabel:"‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡∏ö‡∏≤‡∏ó)",
        hoaLabel:"‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)",
        calcBtn:"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì",
        saveBtn:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì",
        savedMsg:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!",
        backLabel:"‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö",
        chartTitle:"‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ",
        hint:"‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏ì‡∏ë‡πå 28/36 (PITI ‚â§ 28% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞ PITI+‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‚â§ 36%)",
        pass28:"‚úÖ ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‚â§ 28% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ",
        pass36:"‚úÖ ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ + ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‚â§ 36% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ",
        fail28:"‚ùå ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ > 28% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ",
        fail36:"‚ùå ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ + ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô > 36% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ",
        recYes:"‚úÖ ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå",
        recNo:"‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Å‡∏π‡πâ‡∏ö‡πâ‡∏≤‡∏ô",
        currency:"‡∏ö‡∏≤‡∏ó",
        labels:{principal:"‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô",interest:"‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢"}
      }
    };
    let t = langData.en;

    function changeLang(){
      const lang=document.getElementById("lang").value;
      t = langData[lang];
      document.getElementById("title").innerText=t.title;
      document.getElementById("income-label").innerText=t.incomeLabel;
      document.getElementById("expense-label").innerText=t.expenseLabel;
      document.getElementById("savings-label").innerText=t.savingsLabel;
      document.getElementById("price-label").innerText=t.priceLabel;
      document.getElementById("down-label").innerText=t.downLabel;
      document.getElementById("interest-type-label").innerText=t.interestType;
      document.querySelector("#interestType option[value='yearly']").innerText=t.interestYearly;
      document.querySelector("#interestType option[value='monthly']").innerText=t.interestMonthly;
      document.getElementById("interest-label-yearly").innerText=t.interestLabelYearly;
      document.getElementById("interest-label-monthly").innerText=t.interestLabelMonthly;
      document.getElementById("term-label").innerText=t.termLabel;
      document.getElementById("tax-label").innerText=t.taxLabel;
      document.getElementById("ins-label").innerText=t.insLabel;
      document.getElementById("hoa-label").innerText=t.hoaLabel;
      document.getElementById("calc-btn").innerText=t.calcBtn;
      document.getElementById("save-btn").innerText=t.saveBtn;
      document.getElementById("back-label").innerText=t.backLabel;
      document.getElementById("hint").innerText=t.hint;
    }

    function toggleInterestInputs(){
      const type=document.getElementById("interestType").value;
      document.getElementById("yearlyBox").classList.toggle('hidden', type!=='yearly');
      document.getElementById("monthlyBox").classList.toggle('hidden', type!=='monthly');
    }

    document.addEventListener("DOMContentLoaded",()=>{changeLang();toggleInterestInputs();});

    function formatNumber(input){
      const v=input.value.replace(/,/g,'');
      if(!isNaN(v) && v!==""){ input.value=Number(v).toLocaleString('en-US'); }
    }

    const form=document.getElementById("home-plan-form");
    const resultDiv=document.getElementById("result");
    const ctx=document.getElementById("homeChart").getContext("2d");
    let chart;
    let lastInputs=null, lastResults=null;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡πÅ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
    function runCalculation(render=true){
      const income   = Number(document.getElementById("income").value.replace(/,/g,''));
      const expenses = Number(document.getElementById("expenses").value.replace(/,/g,''));
      const savings  = Number(document.getElementById("savings").value.replace(/,/g,''));
      const price    = Number(document.getElementById("homePrice").value.replace(/,/g,''));
      const down     = Number(document.getElementById("downPayment").value.replace(/,/g,''));
      const years    = Number(document.getElementById("years").value);
      const taxPct   = Number(document.getElementById("propTax").value)/100; // yearly %
      const insYear  = Number(document.getElementById("insYear").value.replace(/,/g,'')); // THB/yr
      const hoaMonth = Number(document.getElementById("hoa").value.replace(/,/g,'')); // THB/mo
      const type     = document.getElementById("interestType").value;
      const rYear    = Number(document.getElementById("interestYearly").value||0);
      const rMonth   = Number(document.getElementById("interestMonthly").value||0);

      const loan = Math.max(price - down, 0);
      const n = years*12;
      const i = (type==='yearly') ? (rYear/100/12) : (rMonth/100);

      let mPayment;
      if(i===0){ mPayment = (n>0? loan / n : 0); }
      else{ mPayment = (loan*i) / (1 - Math.pow(1+i, -n)); }

      const totalPayment = mPayment * n;
      const interestAmount = totalPayment - loan;

      // Carrying costs
      const taxMonth = (price * taxPct)/12;
      const insMonth = insYear/12;
      const piti = mPayment + taxMonth + insMonth + hoaMonth;

      // Affordability
      const pass28 = (piti <= 0.28*income);
      const pass36 = (piti + expenses <= 0.36*income);
      const canAfford = (pass28 && pass36) || (savings >= 6*piti);

      const cur = t.currency;

      if(render){
        resultDiv.innerHTML =
        `<div class="badge">${pass28 ? t.pass28 : t.fail28}</div>
         <div class="badge">${pass36 ? t.pass36 : t.fail36}</div>
         <div style="margin-top:10px"></div>
         üßæ <b>Monthly Mortgage (P&I):</b> ${mPayment.toFixed(0).toLocaleString('en-US')} ${cur}<br>
         üè† <b>PITI (Monthly Housing Cost):</b> ${piti.toFixed(0).toLocaleString('en-US')} ${cur}<br>
         üí∞ <b>Total Payable (P&I):</b> ${totalPayment.toFixed(0).toLocaleString('en-US')} ${cur}<br>
         üìà <b>Interest Paid (P&I):</b> ${interestAmount.toFixed(0).toLocaleString('en-US')} ${cur}<br>
         <span class="muted">Includes tax ${ taxMonth.toFixed(0).toLocaleString('en-US') } /mo, insurance ${ insMonth.toFixed(0).toLocaleString('en-US') } /mo, HOA ${ hoaMonth.toFixed(0).toLocaleString('en-US') } /mo.</span>
         <div style="margin-top:12px;font-weight:700;color:${canAfford?'#16a34a':'#dc2626'}">${canAfford ? t.recYes : t.recNo}</div>`;

        if(chart) chart.destroy();
        chart = new Chart(ctx,{
          type:'doughnut',
          data:{ labels:[t.labels.principal, t.labels.interest], datasets:[{ data:[loan, interestAmount], backgroundColor:['#10b981','#ef4444'] }] },
          options:{ responsive:true, plugins:{ legend:{position:'bottom'}, title:{display:true,text:t.chartTitle} } }
        });
      }

      lastInputs = {
        income, expenses, savings, price, downPayment: down, years,
        rateType: type, interestYearly: rYear, interestMonthly: rMonth,
        propTaxPctYear: taxPct*100, insYear, hoaMonth
      };
      lastResults = {
        loanAmount: Math.round(loan),
        totalMonths: n,
        monthlyRate: i,
        monthlyPayment: Math.round(mPayment),         // P & I
        pitiMonthly: Math.round(piti),                // PITI
        totalPaid: Math.round(totalPayment),          // P & I
        totalInterest: Math.round(interestAmount),    // P & I
        taxMonth: Math.round(taxMonth),
        insMonth: Math.round(insMonth),
        hoaMonth: Math.round(hoaMonth),
        pass28, pass36, canAfford
      };

      return {inputs:lastInputs, results:lastResults};
    }

    // Calculate
    form.addEventListener("submit",function(e){
      e.preventDefault();
      runCalculation(true);
    });

    // Save to History (Guest-aware)
    document.getElementById("save-btn").addEventListener("click", ()=>{
      if(!lastResults) runCalculation(false); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const lang = document.getElementById("lang").value;
      const rateText = (lastInputs.rateType==='yearly')
        ? `${lastInputs.interestYearly}%/yr`
        : `${lastInputs.interestMonthly}%/mo`;
      const title = (lang==='th')
        ? `‡∏Å‡∏π‡πâ‡∏ö‡πâ‡∏≤‡∏ô ‚Ä¢ ${lastInputs.years} ‡∏õ‡∏µ @ ${rateText}`
        : `Home ‚Ä¢ ${lastInputs.years}y @ ${rateText}`;

      const id = MMMHistory.save({
        type: "home",
        title,
        inputs: lastInputs,
        results: lastResults,
        meta: { page: "plan-home.html", version: "1.0" }
      });

      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Guest)
      if (id) alert(langData[lang].savedMsg);
    });
  </script>
</body>
</html>
